import { fullStory, events } from '../../../../lib/utils';

/**
 * {{EJ004}} - {{Engangement PLP Changes}}
 */
const Run = () => {
  const Exp = {
    settings: {
      ID: 'EJ004',
      VARIATION: '2',
    },
    cache: (() => {
      // default cached elements for targeting
      const doc = document;
      const bodyVar = doc.body;

      const title = bodyVar.querySelector('.browse__banner-content-inner h2');
      const totalItems = bodyVar.querySelector('.browse__total-result-container');
      const itemWrap = doc.getElementById('list');
      const filterColl = doc.querySelectorAll('#refinement-material .filters-panel__refinement-selector');
      const allProducts = doc.querySelectorAll('.product-tile-list__item');

      return {
        doc,
        bodyVar,
        title,
        totalItems,
        itemWrap,
        filterColl,
        allProducts,
      };
    })(),
    init: () => {
      // Setup
      const { services, settings, components } = Exp;

      Exp.cache.bodyVar.classList.add(settings.ID);
      services.tracking();

      components.contentBuilder();
      components.buildFilters();
      Exp.services.hideFlicker();
    },
    services: {
      /**
       * @desc Inits all page level tracking
       */
      tracking() {
        const { settings } = Exp;
        fullStory(settings.ID, `Variation ${settings.VARIATION}`);
        events.send(settings.ID, 'View', `${settings.ID} activated - Variation Control`);
      },
      hideFlicker: () => {
        const hide = document.getElementById('GDXXX_flickerPrevention');
        hide.parentElement.removeChild(hide);
      },
      shuffle(a) {
        /* eslint-disable */
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
        /* eslint-enable */
      },
      /*
        events.send(`${Exp.settings.ID}`, 'Action', 'Label', { sendOnce: true });
      */
    },
    components: {
      contentBuilder() {
        Exp.cache.title.textContent = 'Engagement Rings';
        Exp.cache.itemWrap.parentNode.insertBefore(Exp.cache.totalItems, Exp.cache.itemWrap);

        Exp.cache.bodyVar.querySelector('.browse__applied-filters').insertAdjacentHTML('afterend', `
          <h3 class="EJ004_title">Shop By Metal Type:</h3>
          <section class="EJ004_filter-wrap"></section>
        `);
        if (Exp.settings.VARIATION === '2') {
          // Define content
          const messagingArr = [
            { msg1: 'Up to 4 years', msg2: 'interest free credit', icon: '<div class="EJ004_percent"><svg class="EJ04_icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 48 48" enable-background="new 0 0 48 48" xml:space="preserve"><g><path d="M36.556,24.828c-6.312,0-11.447,5.185-11.447,11.56s5.136,11.561,11.447,11.561c6.31,0,11.444-5.186,11.444-11.561   S42.865,24.828,36.556,24.828z M36.556,45.068c-4.724,0-8.567-3.895-8.567-8.681s3.844-8.68,8.567-8.68   c4.723,0,8.564,3.894,8.564,8.68S41.278,45.068,36.556,45.068z"/><path d="M11.446,23.172c6.312,0,11.446-5.186,11.446-11.561c0-6.374-5.134-11.56-11.446-11.56C5.135,0.052,0,5.237,0,11.611   C0,17.986,5.135,23.172,11.446,23.172z M11.446,2.932c4.723,0,8.566,3.894,8.566,8.68s-3.843,8.681-8.566,8.681   S2.88,16.397,2.88,11.611S6.723,2.932,11.446,2.932z"/><path d="M46.556,1.132C45.99,0.573,45.078,0.58,44.52,1.146L1.43,44.829c-0.558,0.566-0.552,1.479,0.014,2.037   c0.28,0.277,0.646,0.415,1.011,0.415c0.372,0,0.744-0.144,1.025-0.429L46.57,3.169C47.128,2.603,47.122,1.69,46.556,1.132z"/></g></svg></div>' },
            { msg1: 'Lifetime diamond', msg2: 'cleaning promise', icon: '<div class="EJ004_svg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve"><path d="M89.605,77.99l-2.528-1.383c-2.355-1.288-4.281-3.214-5.569-5.569l-1.383-2.528c-0.351-0.642-1.404-0.642-1.755,0  l-1.383,2.528c-1.288,2.355-3.214,4.281-5.569,5.569l-2.529,1.383c-0.32,0.175-0.52,0.512-0.52,0.877s0.2,0.702,0.52,0.877  l2.529,1.383c2.355,1.288,4.281,3.214,5.569,5.569l1.383,2.529c0.175,0.32,0.512,0.52,0.877,0.52s0.702-0.2,0.877-0.52l1.383-2.529  c1.288-2.355,3.214-4.281,5.569-5.569l2.528-1.383c0.321-0.175,0.52-0.512,0.52-0.877S89.926,78.166,89.605,77.99z M86.117,79.373  c-2.691,1.472-4.892,3.672-6.364,6.364l-0.505,0.924l-0.505-0.924c-1.472-2.691-3.673-4.892-6.364-6.364l-0.924-0.505l0.924-0.505  c2.691-1.472,4.892-3.673,6.364-6.364l0.505-0.924l0.505,0.924c1.472,2.691,3.673,4.892,6.364,6.364l0.924,0.505L86.117,79.373z"/><path d="M13.262,61.824l-2.617,1.431c-0.321,0.175-0.52,0.512-0.52,0.877s0.199,0.702,0.52,0.877l2.617,1.431  c2.443,1.336,4.441,3.334,5.777,5.777l1.431,2.617c0.175,0.321,0.512,0.52,0.877,0.52s0.702-0.199,0.877-0.52l1.431-2.617  c1.01-1.847,2.4-3.439,4.073-4.683L49.494,89.45c0.015,0.016,0.037,0.022,0.054,0.036c0.066,0.058,0.137,0.106,0.216,0.145  c0.031,0.016,0.06,0.033,0.092,0.045c0.11,0.041,0.226,0.07,0.348,0.07c0.003,0,0.006,0,0.009,0c0.121-0.001,0.235-0.029,0.343-0.07  c0.032-0.012,0.059-0.03,0.089-0.045c0.079-0.039,0.15-0.087,0.216-0.145c0.016-0.014,0.037-0.02,0.052-0.035l38.896-39.166  c0,0,0,0,0.001-0.001l0.002-0.002c0.086-0.087,0.15-0.188,0.198-0.294c0.014-0.031,0.019-0.064,0.029-0.097  c0.028-0.085,0.047-0.17,0.052-0.258c0.001-0.019,0.011-0.036,0.011-0.055c0-0.024-0.012-0.045-0.014-0.069  c-0.006-0.082-0.022-0.161-0.049-0.241c-0.014-0.041-0.024-0.081-0.043-0.12c-0.009-0.019-0.011-0.04-0.021-0.058L75.117,22.449  c-0.177-0.316-0.511-0.513-0.874-0.513H26.163c-0.363,0-0.697,0.196-0.874,0.513L10.431,49.09c-0.01,0.018-0.012,0.039-0.021,0.058  c-0.019,0.039-0.029,0.079-0.043,0.12c-0.026,0.08-0.043,0.159-0.049,0.241c-0.002,0.024-0.014,0.044-0.014,0.069  c0,0.019,0.01,0.036,0.011,0.055c0.005,0.089,0.024,0.174,0.052,0.258c0.011,0.032,0.016,0.066,0.029,0.097  c0.048,0.107,0.112,0.208,0.198,0.294l0.002,0.002c0,0,0,0,0.001,0.001l7.375,7.426C16.724,59.402,15.123,60.806,13.262,61.824z   M21.901,71.258l-0.554,1.013l-0.554-1.013c-1.52-2.779-3.793-5.052-6.572-6.572l-1.013-0.554l1.013-0.554  c2.779-1.52,5.052-3.793,6.572-6.572l0.554-1.013l0.554,1.013c1.52,2.779,3.793,5.052,6.572,6.572l1.013,0.554l-1.013,0.554  C25.694,66.206,23.421,68.479,21.901,71.258z M34.539,50.577L47.58,84.686L29.451,66.431l2.599-1.421  c0.321-0.175,0.52-0.512,0.52-0.877s-0.199-0.702-0.52-0.877l-2.617-1.431c-2.443-1.336-4.441-3.334-5.777-5.777l-1.431-2.617  c-0.351-0.642-1.404-0.642-1.755,0l-1.396,2.552l-5.367-5.405H34.539z M86.699,50.577L52.677,84.836l12.357-34.259H86.699z   M62.908,50.577L50.176,85.874L36.68,50.577H62.908z M37.021,48.577L49.78,25.324l12.759,23.253H37.021z M87.399,48.577H64.82  L51.299,23.936h22.357L87.399,48.577z M26.75,23.936h21.511L34.74,48.577H13.008L26.75,23.936z"/><path d="M70.267,41.25h2.566v2.226c0,0.552,0.448,1,1,1s1-0.448,1-1V41.25h2.566c0.552,0,1-0.448,1-1s-0.448-1-1-1h-2.566v-2.226  c0-0.552-0.448-1-1-1s-1,0.448-1,1v2.226h-2.566c-0.552,0-1,0.448-1,1S69.715,41.25,70.267,41.25z"/><path d="M33.621,18.451c0.552,0,1-0.448,1-1v-2.225h2.566c0.552,0,1-0.448,1-1s-0.448-1-1-1h-2.566V11c0-0.552-0.448-1-1-1  s-1,0.448-1,1v2.226h-2.566c-0.552,0-1,0.448-1,1s0.448,1,1,1h2.566v2.225C32.621,18.003,33.068,18.451,33.621,18.451z"/><path d="M13.933,21.855c-0.552,0-1,0.448-1,1v1.376h-1.628c-0.552,0-1,0.448-1,1s0.448,1,1,1h1.628v1.377c0,0.552,0.448,1,1,1  s1-0.448,1-1v-1.377h1.628c0.552,0,1-0.448,1-1s-0.448-1-1-1h-1.628v-1.376C14.933,22.303,14.485,21.855,13.933,21.855z"/><path d="M21.831,42.637c0.158,0.091,0.33,0.135,0.5,0.135c0.345,0,0.681-0.179,0.866-0.499l7.558-13.056  c0.277-0.478,0.114-1.09-0.364-1.366c-0.478-0.277-1.09-0.114-1.366,0.364l-7.558,13.056C21.19,41.749,21.353,42.36,21.831,42.637z"/></svg></div>' },
            { msg1: 'Conflict-free', msg2: 'diamonds', icon: '<div class="EJ004_svg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 64 64" style="enable-background:new 0 0 64 64;" xml:space="preserve"><path d="M61.016,41H50.191c-1.352,0-2.528,0.85-2.977,2h-5.204c-0.457,0-0.826,0.312-0.946,0.73l-8.052-1.88  c-0.608-0.142-1.262-0.093-1.839,0.143l-7.879,3.202c-1.026,0.42-1.8,1.264-2.124,2.252L5.959,42.84  c-0.925-0.282-1.95-0.097-2.74,0.489C2.444,43.904,2,44.772,2,45.711v2.235c0,0.953,0.546,1.91,1.428,2.498l11.201,7.406  c0.099,0.065,0.208,0.112,0.323,0.14l16.544,3.892c0.225,0.053,0.457,0.079,0.688,0.079c0.232,0,0.463-0.026,0.688-0.079l8.631-2.04  C41.654,59.933,41.821,60,42.011,60h5.204c0.449,1.15,1.625,2,2.977,2h10.824c0.552,0,1-0.447,1-1V42  C62.016,41.447,61.568,41,61.016,41z M41.011,57.903l-8.598,2.032c-0.152,0.037-0.306,0.037-0.458,0l-16.371-3.851L4.535,48.778  C4.215,48.565,4,48.23,4,47.946v-2.235c0-0.299,0.15-0.582,0.412-0.775c0.284-0.21,0.646-0.278,0.968-0.182l15.807,4.787  C21.675,50.95,23.098,52,24.724,52h7.284c0.552,0,1-0.447,1-1s-0.448-1-1-1h-7.284c-0.776,0-1.493-0.541-1.675-1.205  c0.004-0.114-0.011-0.226-0.044-0.332c0.005-0.584,0.434-1.165,1.045-1.415l7.877-3.201c0.191-0.079,0.427-0.097,0.63-0.049  l8.453,1.974V57.903z M47.012,58H43.12l0.058-12.979c0-0.008-0.003-0.014-0.004-0.021h3.838V58z M60.016,60h-9.824  c-0.595,0-1.179-0.495-1.179-1V44c0-0.505,0.584-1,1.179-1h9.824V60z"/><path d="M53.014,58h3c0.552,0,1-0.447,1-1s-0.448-1-1-1h-3c-0.552,0-1,0.447-1,1S52.461,58,53.014,58z"/><path d="M31.546,37.818c0.066,0.056,0.138,0.101,0.216,0.139c0.031,0.014,0.058,0.032,0.09,0.043  c0.106,0.038,0.217,0.063,0.334,0.063s0.228-0.025,0.334-0.063c0.031-0.011,0.059-0.028,0.09-0.043  c0.078-0.037,0.15-0.083,0.216-0.139c0.016-0.014,0.037-0.019,0.052-0.034L52.53,18.934c0.215-0.078,0.404-0.222,0.524-0.426  c0.18-0.305,0.185-0.682,0.014-0.991l-4.972-9C47.919,8.197,47.583,8,47.22,8c-0.001,0-0.002,0-0.003,0  c-0.004,0-0.008,0.002-0.013,0.002C47.199,8.002,47.195,8,47.19,8h-9.87c-0.018,0-0.035,0.006-0.053,0.007  C37.251,8.006,37.234,8,37.217,8c-0.001,0-0.002,0-0.003,0c-0.004,0-0.008,0.002-0.013,0.002C37.196,8.002,37.192,8,37.188,8h-9.869  c-0.018,0-0.035,0.006-0.053,0.007C27.248,8.006,27.232,8,27.214,8c-0.001,0-0.002,0-0.003,0c-0.004,0-0.008,0.002-0.013,0.002  C27.194,8.002,27.19,8,27.185,8h-9.87c-0.018,0-0.035,0.006-0.053,0.007C17.245,8.006,17.229,8,17.211,8c-0.001,0-0.002,0-0.003,0  c-0.365,0.001-0.701,0.201-0.875,0.522l-4.897,9c-0.01,0.019-0.014,0.041-0.023,0.06c-0.007,0.016-0.019,0.028-0.026,0.044  c-0.008,0.019-0.008,0.04-0.014,0.06c-0.019,0.056-0.032,0.113-0.04,0.171c-0.005,0.035-0.01,0.069-0.011,0.105  c-0.002,0.06,0.003,0.118,0.012,0.177c0.005,0.033,0.007,0.065,0.014,0.098c0.015,0.062,0.04,0.121,0.067,0.179  c0.012,0.027,0.02,0.054,0.034,0.08c0.003,0.005,0.004,0.01,0.006,0.015c0.046,0.078,0.102,0.147,0.165,0.208  c0.001,0.001,0.001,0.002,0.002,0.003l19.872,19.062C31.509,37.799,31.53,37.804,31.546,37.818z M32.186,34.441L25.812,19h6.375  h0.025h0.003h0.104h6.24L32.186,34.441z M34.924,33.05l5.8-14.05h1.465h0.026h0.003h0.104h7.249L34.924,33.05z M47.227,11.08  l3.27,5.92h-6.492L47.227,11.08z M45.495,10l-3.27,5.92L39.003,10H45.495z M37.224,11.08l3.27,5.92h-0.439h-6.052L37.224,11.08z   M35.492,10l-3.27,5.92L29.001,10H35.492z M27.221,11.08l3.27,5.92h-6.174H24L27.221,11.08z M25.49,10l-3.27,5.92L18.998,10H25.49z   M17.218,11.08l3.27,5.92h-6.491L17.218,11.08z M14.802,19h7.382h0.026h0.003h0.104h1.331l5.8,14.05L14.802,19z"/><path d="M14.003,38c0.552,0,1-0.447,1-1v-2h2.001c0.552,0,1-0.447,1-1s-0.448-1-1-1h-2.001v-2c0-0.553-0.448-1-1-1s-1,0.447-1,1v2  h-2.001c-0.552,0-1,0.447-1,1s0.448,1,1,1h2.001v2C13.003,37.553,13.451,38,14.003,38z"/><path d="M60.315,4.879c-0.391-0.391-1.024-0.391-1.415,0l-0.708,0.707l-0.708-0.707c-0.391-0.391-1.024-0.391-1.415,0  c-0.39,0.391-0.39,1.023,0,1.414L56.779,7l-0.707,0.707c-0.391,0.391-0.391,1.023,0,1.414c0.195,0.195,0.452,0.293,0.708,0.293  s0.512-0.098,0.707-0.293l0.708-0.707l0.708,0.707c0.195,0.195,0.451,0.293,0.707,0.293s0.512-0.098,0.708-0.293  c0.39-0.391,0.39-1.023,0-1.414L59.608,7l0.707-0.707C60.706,5.902,60.706,5.27,60.315,4.879z"/><path d="M54.014,36c1.655,0,3-1.346,3-3s-1.346-3-3-3s-3,1.346-3,3S52.359,36,54.014,36z M54.014,32c0.552,0,1,0.448,1,1  s-0.449,1-1,1s-1-0.448-1-1S53.462,32,54.014,32z"/><path d="M5.001,5c0,1.654,1.346,3,3,3s3-1.346,3-3s-1.346-3-3-3S5.001,3.346,5.001,5z M9.002,5c0,0.552-0.449,1-1,1s-1-0.448-1-1  s0.449-1,1-1S9.002,4.448,9.002,5z"/></svg></div>' },
            { msg1: 'Lifetime diamond', msg2: 'guarantee', icon: '<div class="EJ004_svg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 32 32" enable-background="new 0 0 32 32" xml:space="preserve"><g><path d="M3.5,32h25V5L24,0H3.5V32z M5.5,2h17.073v4.587H26.5V30h-21V2z"/><path d="M16,8.842H9.645l-2.542,3.807L16,25.339l8.897-12.69l-2.542-3.807H16z M10.24,9.954h3.192l-1.396,2.417H8.626L10.24,9.954z    M8.656,12.927h3.337l2.844,8.816L8.656,12.927z M16,23.401l-0.081-0.116l-3.346-10.358h10.772L16,23.401z M12.672,12.371   l1.4-2.417H16h5.76l1.614,2.417H12.672z"/></g></svg></div>' },
          ];
          // Shuffle content for randomness
          Exp.services.shuffle(messagingArr);

          messagingArr.forEach((item, index) => {
            const ind = (index + 1) * 5;

            Exp.cache.allProducts[ind].insertAdjacentHTML('afterend', `
              <li class="EJ004_ingrid-content">
                ${item.icon}
                <h4>Why buy diamonds from Ernest Jones?</h4>
                <span>${item.msg1}</span>
                <span>${item.msg2}</span>
              </li>
            `);
          });
        }
      },
      buildFilters() {
        const filterWrap = Exp.cache.bodyVar.querySelector('.EJ004_filter-wrap');

        [].forEach.call(Exp.cache.filterColl, (item) => {
          const link = item.querySelector('.filters-panel__refinement-link');
          const { href } = link;
          const text = link.childNodes[0].nodeValue.trim();
          let classList = 'EJ004_filter-item';
          if (link.classList.contains('checked')) {
            classList += ' EJ004_active';
          }

          filterWrap.insertAdjacentHTML('beforeend', `<a href="${href}" class="${classList}">${text}</a>`);
        });
      },
    },
  };

  Exp.init();
};

export default Run;
