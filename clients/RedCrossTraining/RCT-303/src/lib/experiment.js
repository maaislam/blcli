/**
 * ID - Description
 *
 * @fileoverview The main experiment logic goes here. Everything should be written inside the
 * activate function which is called if the conditions in triggers.js have passed evaluation
 * @author User Conversion
 */
import { setup, fireEvent, newEvents } from '../../../../../core-files/services';
import shared from '../../../../../core-files/shared';
import { logMessage, pollerLite } from '../../../../../lib/utils';

const { ID, VARIATION, CLIENT, LIVECODE } = shared;

const trustpilotLogo = `
<svg xmlns="http://www.w3.org/2000/svg" width="93" height="22" viewBox="0 0 93 24" fill="none">
  <g clip-path="url(#clip0_2006_36)">
    <path d="M24.3558 8.55127H33.7398V10.3021H30.05V20.1441H28.021V10.3021H24.3477V8.55127H24.3558ZM33.3389 11.7501H35.0733V13.37H35.106C35.1633 13.1409 35.2697 12.9201 35.4251 12.7073C35.5805 12.4946 35.7687 12.2901 35.9896 12.1183C36.2105 11.9383 36.4559 11.7992 36.7259 11.6847C36.9959 11.5783 37.2741 11.5211 37.5522 11.5211C37.7649 11.5211 37.9204 11.5292 38.0022 11.5374C38.084 11.5456 38.1658 11.562 38.2558 11.5701V13.3537C38.1249 13.3291 37.994 13.3128 37.8549 13.2964C37.7159 13.28 37.585 13.2718 37.4541 13.2718C37.1432 13.2718 36.8486 13.3373 36.5705 13.46C36.2923 13.5827 36.0551 13.7709 35.8505 14.0082C35.646 14.2536 35.4824 14.5481 35.3597 14.9081C35.2369 15.2681 35.1797 15.6771 35.1797 16.1435V20.1359H33.3307V11.7501H33.3389ZM46.7562 20.1441H44.9399V18.9742H44.9072C44.6781 19.3996 44.3427 19.735 43.8927 19.9886C43.4427 20.2423 42.9846 20.3732 42.5183 20.3732C41.4138 20.3732 40.612 20.1032 40.1212 19.555C39.6303 19.0069 39.3848 18.1806 39.3848 17.0761V11.7501H41.2338V16.8961C41.2338 17.6324 41.3729 18.156 41.6592 18.4588C41.9374 18.7615 42.3383 18.9169 42.8455 18.9169C43.2382 18.9169 43.5573 18.8596 43.8191 18.7369C44.0809 18.6142 44.2936 18.4588 44.449 18.2542C44.6127 18.0579 44.7272 17.8124 44.8008 17.5343C44.8745 17.2561 44.9072 16.9534 44.9072 16.6262V11.7583H46.7562V20.1441ZM49.906 17.4525C49.9632 17.9924 50.1678 18.3688 50.5195 18.5897C50.8795 18.8024 51.305 18.9169 51.804 18.9169C51.9758 18.9169 52.1722 18.9005 52.3931 18.876C52.614 18.8515 52.8267 18.7942 53.0148 18.7206C53.2112 18.6469 53.3666 18.5324 53.4975 18.3851C53.6203 18.2379 53.6775 18.0497 53.6693 17.8124C53.6612 17.5752 53.5712 17.3788 53.4075 17.2316C53.2439 17.0761 53.0394 16.9616 52.7858 16.8634C52.5321 16.7734 52.2458 16.6916 51.9185 16.6262C51.5913 16.5607 51.264 16.4871 50.9286 16.4134C50.585 16.3398 50.2496 16.2416 49.9305 16.1353C49.6114 16.0289 49.3251 15.8817 49.0715 15.6935C48.8178 15.5135 48.6133 15.2763 48.4661 14.9899C48.3106 14.7036 48.237 14.3518 48.237 13.9263C48.237 13.4682 48.3515 13.0919 48.5724 12.781C48.7933 12.4701 49.0796 12.2246 49.4151 12.0365C49.7587 11.8483 50.135 11.7174 50.5523 11.6356C50.9695 11.562 51.3704 11.5211 51.7467 11.5211C52.1803 11.5211 52.5976 11.5701 52.9903 11.6601C53.383 11.7501 53.743 11.8974 54.062 12.1101C54.3811 12.3146 54.6429 12.5846 54.8556 12.9119C55.0683 13.2391 55.1992 13.64 55.2565 14.1063H53.3257C53.2357 13.6645 53.0394 13.3618 52.7203 13.2146C52.4012 13.0591 52.0331 12.9855 51.624 12.9855C51.4931 12.9855 51.3377 12.9937 51.1577 13.0182C50.9777 13.0428 50.8141 13.0837 50.6504 13.1409C50.495 13.1982 50.3641 13.2882 50.2496 13.4027C50.1432 13.5173 50.0859 13.6645 50.0859 13.8527C50.0859 14.0818 50.1678 14.2618 50.3232 14.4009C50.4786 14.5399 50.6832 14.6545 50.9368 14.7527C51.1904 14.8426 51.4768 14.9245 51.804 14.9899C52.1313 15.0554 52.4667 15.129 52.8103 15.2026C53.1457 15.2763 53.473 15.3744 53.8002 15.4808C54.1275 15.5871 54.4138 15.7344 54.6675 15.9226C54.9211 16.1107 55.1256 16.3398 55.2811 16.618C55.4365 16.8961 55.5183 17.2479 55.5183 17.657C55.5183 18.156 55.4038 18.5733 55.1747 18.9251C54.9456 19.2687 54.6511 19.555 54.2911 19.7678C53.9311 19.9805 53.5221 20.1441 53.0803 20.2423C52.6385 20.3404 52.1967 20.3895 51.7631 20.3895C51.2313 20.3895 50.7404 20.3323 50.2905 20.2095C49.8405 20.0868 49.4478 19.9068 49.1206 19.6696C48.7933 19.4241 48.5315 19.1214 48.3433 18.7615C48.1552 18.4015 48.057 17.9679 48.0406 17.4688H49.906V17.4525ZM56.0092 11.7501H57.4082V9.23031H59.2571V11.7501H60.9261V13.1328H59.2571V17.6161C59.2571 17.8124 59.2653 17.9761 59.2817 18.1233C59.2981 18.2624 59.339 18.3851 59.3962 18.4833C59.4535 18.5815 59.5435 18.6551 59.6662 18.7042C59.7889 18.7533 59.9444 18.7778 60.1571 18.7778C60.288 18.7778 60.4189 18.7778 60.5498 18.7696C60.6807 18.7615 60.8116 18.7451 60.9425 18.7124V20.1441C60.738 20.1686 60.5334 20.185 60.3453 20.2095C60.1489 20.2341 59.9526 20.2423 59.748 20.2423C59.2571 20.2423 58.8644 20.1932 58.5699 20.1032C58.2754 20.0132 58.0381 19.8741 57.8745 19.6941C57.7027 19.5141 57.5964 19.2932 57.5309 19.0233C57.4736 18.7533 57.4327 18.4424 57.4245 18.0988V13.1491H56.0255V11.7501H56.0092ZM62.2351 11.7501H63.9859V12.8873H64.0187C64.2804 12.3965 64.6404 12.0528 65.1068 11.8401C65.5731 11.6274 66.0721 11.5211 66.6203 11.5211C67.283 11.5211 67.8557 11.6356 68.3465 11.8729C68.8374 12.1019 69.2465 12.421 69.5737 12.8301C69.901 13.2391 70.1382 13.7136 70.3019 14.2536C70.4655 14.7936 70.5473 15.3744 70.5473 15.988C70.5473 16.5525 70.4737 17.1007 70.3264 17.6243C70.1791 18.156 69.9583 18.6224 69.6637 19.0314C69.3692 19.4405 68.9929 19.7596 68.5347 20.005C68.0766 20.2504 67.5448 20.3732 66.923 20.3732C66.653 20.3732 66.383 20.3486 66.1131 20.2995C65.8431 20.2504 65.5813 20.1686 65.3358 20.0623C65.0904 19.9559 64.8531 19.8168 64.6486 19.645C64.4359 19.4732 64.2641 19.2769 64.1168 19.056H64.0841V23.2448H62.2351V11.7501ZM68.6983 15.9553C68.6983 15.579 68.6493 15.2108 68.5511 14.8508C68.4529 14.4909 68.3056 14.18 68.1093 13.9018C67.9129 13.6236 67.6675 13.4027 67.3812 13.2391C67.0866 13.0755 66.7512 12.9855 66.3749 12.9855C65.5976 12.9855 65.0086 13.2555 64.6159 13.7954C64.2232 14.3354 64.0268 15.0554 64.0268 15.9553C64.0268 16.3807 64.0759 16.7734 64.1823 17.1334C64.2886 17.4934 64.4359 17.8043 64.6486 18.0661C64.8531 18.3279 65.0986 18.5324 65.3849 18.6796C65.6713 18.8351 66.0067 18.9087 66.383 18.9087C66.8085 18.9087 67.1603 18.8187 67.4548 18.6469C67.7493 18.4751 67.9866 18.246 68.1747 17.9761C68.3629 17.6979 68.502 17.387 68.5838 17.0352C68.6574 16.6834 68.6983 16.3235 68.6983 15.9553ZM71.9627 8.55127H73.8116V10.3021H71.9627V8.55127ZM71.9627 11.7501H73.8116V20.1441H71.9627V11.7501ZM75.4643 8.55127H77.3132V20.1441H75.4643V8.55127ZM82.9828 20.3732C82.312 20.3732 81.7147 20.2586 81.1911 20.0377C80.6675 19.8168 80.2258 19.506 79.8576 19.1214C79.4976 18.7287 79.2195 18.2624 79.0313 17.7224C78.8431 17.1825 78.7449 16.5852 78.7449 15.9389C78.7449 15.3008 78.8431 14.7117 79.0313 14.1718C79.2195 13.6318 79.4976 13.1655 79.8576 12.7728C80.2176 12.3801 80.6675 12.0774 81.1911 11.8565C81.7147 11.6356 82.312 11.5211 82.9828 11.5211C83.6537 11.5211 84.2509 11.6356 84.7745 11.8565C85.2981 12.0774 85.7399 12.3883 86.1081 12.7728C86.4681 13.1655 86.7462 13.6318 86.9344 14.1718C87.1226 14.7117 87.2207 15.3008 87.2207 15.9389C87.2207 16.5852 87.1226 17.1825 86.9344 17.7224C86.7462 18.2624 86.4681 18.7287 86.1081 19.1214C85.7481 19.5141 85.2981 19.8168 84.7745 20.0377C84.2509 20.2586 83.6537 20.3732 82.9828 20.3732ZM82.9828 18.9087C83.3919 18.9087 83.7519 18.8187 84.0546 18.6469C84.3573 18.4751 84.6027 18.246 84.7991 17.9679C84.9954 17.6897 85.1345 17.3706 85.2327 17.0189C85.3227 16.6671 85.3718 16.3071 85.3718 15.9389C85.3718 15.579 85.3227 15.2272 85.2327 14.8672C85.1427 14.5072 84.9954 14.1963 84.7991 13.9182C84.6027 13.64 84.3573 13.4191 84.0546 13.2473C83.7519 13.0755 83.3919 12.9855 82.9828 12.9855C82.5738 12.9855 82.2138 13.0755 81.9111 13.2473C81.6084 13.4191 81.3629 13.6482 81.1666 13.9182C80.9702 14.1963 80.8312 14.5072 80.733 14.8672C80.643 15.2272 80.5939 15.579 80.5939 15.9389C80.5939 16.3071 80.643 16.6671 80.733 17.0189C80.823 17.3706 80.9702 17.6897 81.1666 17.9679C81.3629 18.246 81.6084 18.4751 81.9111 18.6469C82.2138 18.8269 82.5738 18.9087 82.9828 18.9087ZM87.7607 11.7501H89.1597V9.23031H91.0087V11.7501H92.6777V13.1328H91.0087V17.6161C91.0087 17.8124 91.0168 17.9761 91.0332 18.1233C91.0496 18.2624 91.0905 18.3851 91.1478 18.4833C91.205 18.5815 91.295 18.6551 91.4177 18.7042C91.5405 18.7533 91.6959 18.7778 91.9086 18.7778C92.0395 18.7778 92.1704 18.7778 92.3013 18.7696C92.4322 18.7615 92.5631 18.7451 92.694 18.7124V20.1441C92.4895 20.1686 92.285 20.185 92.0968 20.2095C91.9004 20.2341 91.7041 20.2423 91.4995 20.2423C91.0087 20.2423 90.616 20.1932 90.3214 20.1032C90.0269 20.0132 89.7897 19.8741 89.626 19.6941C89.4542 19.5141 89.3479 19.2932 89.2824 19.0233C89.2252 18.7533 89.1842 18.4424 89.1761 18.0988V13.1491H87.7771V11.7501H87.7607Z" fill="white"/>
    <path d="M22.1958 8.55132H13.72L11.102 0.484619L8.47578 8.55132L0 8.54314L6.86408 13.5337L4.23789 21.5922L11.102 16.6098L17.9579 21.5922L15.3399 13.5337L22.1958 8.55132Z" fill="#00B67A"/>
    <path d="M15.9288 15.3579L15.3397 13.5334L11.1018 16.6096L15.9288 15.3579Z" fill="#005128"/>
  </g>
  <defs>
    <clipPath id="clip0_2006_36">
      <rect width="92.6776" height="22.7602" fill="white" transform="translate(0 0.484619)"/>
    </clipPath>
  </defs>
</svg>`;

const trustpilotStars = `
<svg xmlns="http://www.w3.org/2000/svg" width="138" height="22" viewBox="0 0 138 26" fill="none">
  <g clip-path="url(#clip0_2013_37)">
    <path d="M26.4564 0H0.727051V25.7294H26.4564V0Z" fill="#00B67A"/>
    <path d="M54.33 0H28.6007V25.7294H54.33V0Z" fill="#00B67A"/>
    <path d="M82.2037 0H56.4744V25.7294H82.2037V0Z" fill="#00B67A"/>
    <path d="M110.077 0H84.3472V25.7294H110.077V0Z" fill="#00B67A"/>
    <path d="M137.95 0H112.221V25.7294H137.95V0Z" fill="#00B67A"/>
    <path d="M13.5918 17.341L17.5048 16.3493L19.1397 21.388L13.5918 17.341ZM22.5971 10.8282H15.7091L13.5918 4.34229L11.4745 10.8282H4.58655L10.1612 14.8485L8.04392 21.3344L13.6186 17.3142L17.0492 14.8485L22.5971 10.8282Z" fill="white"/>
    <path d="M41.4653 17.341L45.3783 16.3493L47.0132 21.388L41.4653 17.341ZM50.4706 10.8282H43.5826L41.4653 4.34229L39.348 10.8282H32.4601L38.0348 14.8485L35.9175 21.3344L41.4921 17.3142L44.9227 14.8485L50.4706 10.8282Z" fill="white"/>
    <path d="M69.3388 17.341L73.2518 16.3493L74.8866 21.388L69.3388 17.341ZM78.344 10.8282H71.4561L69.3388 4.34229L67.2214 10.8282H60.3335L65.9082 14.8485L63.7909 21.3344L69.3656 17.3142L72.7961 14.8485L78.344 10.8282Z" fill="white"/>
    <path d="M97.2118 17.341L101.125 16.3493L102.76 21.388L97.2118 17.341ZM106.217 10.8282H99.3291L97.2118 4.34229L95.0945 10.8282H88.2065L93.7812 14.8485L91.6639 21.3344L97.2386 17.3142L100.669 14.8485L106.217 10.8282Z" fill="white"/>
    <path d="M125.086 17.341L128.999 16.3493L130.634 21.388L125.086 17.341ZM134.091 10.8282H127.203L125.086 4.34229L122.969 10.8282H116.081L121.655 14.8485L119.538 21.3344L125.113 17.3142L128.543 14.8485L134.091 10.8282Z" fill="white"/>
  </g>
  <defs>
    <clipPath id="clip0_2013_37">
      <rect width="137.223" height="25.7294" fill="white" transform="translate(0.727051)"/>
    </clipPath>
  </defs>
</svg>`;

// trustpilotHtml = `
// <div class="${ID}-trustpilot-container">
//   <a href="https://uk.trustpilot.com/review/redcrossfirstaidtraining.co.uk?utm_medium=trustbox&utm_source=Mini" class="${ID}-trustpilot-container-section">
//     <div class="${ID}-trustpilot-container-section-top">
//       ${trustpilotLogo} ${trustpilotStars}
//     </div>
//     <div class="${ID}-trustpilot-container-section-bottom">
//       <p>TrustScore 4.9 | 4,294 reviews</p>
//     </div>
//   </a>
// </div>
// `;

const startExperiment = () => {
  pollerLite(['main .homepage-hero .homepage-hero--position .homepage-hero--text'], () => {

    console.log('experiment started');

    let trustpilotHtml = '';

    if(VARIATION === '1'){  
      trustpilotHtml = `
      <div class="${ID}-trustpilot-container">
        <a href="https://uk.trustpilot.com/review/redcrossfirstaidtraining.co.uk?utm_medium=trustbox&utm_source=Mini" class="${ID}-trustpilot-container-section">
            <span>Excellent</span> ${trustpilotStars} ${trustpilotLogo}
        </a>
      </div>
      `;
    } else if (VARIATION === '2') {
        trustpilotHtml = `
        <div class="${ID}-trustpilot-container">
        <a href="https://uk.trustpilot.com/review/redcrossfirstaidtraining.co.uk?utm_medium=trustbox&utm_source=Mini" class="${ID}-trustpilot-container-section">
            <span>Excellent 4.9 out of 5</span> ${trustpilotLogo}
        </a>
        </div>
        `;

    }

    const target = document.querySelector('.homepage-hero .homepage-hero--position .homepage-hero--text');
    // console.log(target);
    target.insertAdjacentHTML('beforeend', trustpilotHtml);
  });
}

const addTracking = () => {
  // console.log('add tracking');
  // const ogTrustpilot = document.querySelector('.navigation-buttons-large .trustpilot-widget iframe');
  // console.log(ogTrustpilot);
  document.body.addEventListener('click', (e) => {
    if(e.target.closest(`.navigation-buttons-large .trustpilot-widget iframe`)) {
      // console.log('click trustpilot');
      fireEvent('Click - user clicks header trustpilot');
    }
  });
}

const variationTracking = () => {
  // console.log('variation tracking');
  document.body.addEventListener('click', (e) => {
    if(e.target.closest(`.${ID}-trustpilot-container-section`)) {
      // console.log('click homepage trustpilot');
      fireEvent('Click - user clicks homepage trustpilot');
    }
  });
}

export default () => {

  newEvents.initiate = true;
  newEvents.methods = ['ga4'];
  newEvents.property = 'G-2N7DXLH3YG';

  setup();

  logMessage(ID + " Variation: "+VARIATION);

  fireEvent('Conditions Met');

  // -----------------------------
  // Add events that apply to both variant and control
  // @see https://app.gitbook.com/@userconversion/s/development/events/helpers/
  // -----------------------------
  // ...
  addTracking();
  // -----------------------------
  // If control, bail out from here
  // -----------------------------
  if(VARIATION == 'control') {
    return;
  }

  // -----------------------------
  // Write experiment code here
  // -----------------------------
  // ...
  startExperiment();
  variationTracking();
};
