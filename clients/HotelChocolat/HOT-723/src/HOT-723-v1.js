(function () {
  const plpData = [
    {
      plpPageName: 'Birthday Chocolate',
      pageUrl: '/uk/shop/gift-ideas/shop-by-occasion/birthday/',
      data: [
        {
          name: 'Boxed Chocolates',
          link: '/uk/shop/gift-ideas/shop-by-occasion/birthday/?prefn1=productType&prefv1=Boxed%20Chocolates',
          title: 'Refine by:Boxed Chocolates',
        },
        {
          name: 'Vegan',
          link: '/uk/shop/gift-ideas/shop-by-occasion/birthday/?prefn1=isSuitableVegan&prefv1=true',
          title: 'Refine by:Suitable for vegans*',
        },
        {
          name: 'Hot Chocolate',
          link: '/uk/shop/gift-ideas/shop-by-occasion/birthday/?prefn1=productType&prefv1=Hot%20Chocolate',
          title: 'Refine by:Hot Chocolate',
        },
        {
          name: 'Alcohol',
          link: '/uk/shop/gift-ideas/shop-by-occasion/birthday/?prefn1=productType&prefv1=Alcohol',
          title: 'Refine by:Alcohol',
        },
        {
          name: 'Hampers',
          link: '/uk/shop/gift-ideas/shop-by-occasion/birthday/?prefn1=productType&prefv1=Hampers',
          title: 'Refine by:Hampers',
        },
        {
          name: 'Dark',
          link: '/uk/shop/gift-ideas/shop-by-occasion/birthday/?prefn1=chocolateTypes&prefv1=Dark',
          title: 'Refine by:Dark',
        },
        {
          name: 'Lovely Little Things',
          link: '/uk/shop/gift-ideas/shop-by-occasion/birthday/?prefn1=productType&prefv1=Lovely%20Little%20Things',
          title: 'Refine by:Lovely Little Things',
        },
        {
          name: 'Biscuits',
          link: '/uk/shop/gift-ideas/shop-by-occasion/birthday/?prefn1=productType&prefv1=Biscuits',
          title: 'Refine by:Biscuits',
        },
      ],
    },
    {
      plpPageName: 'Gift Ideas',
      pageUrl: '/uk/shop/gift-ideas/',
      data: [
        {
          name: 'Boxed Chocolate',
          link: '/uk/shop/gift-ideas/?prefn1=productType&prefv1=Boxed%20Chocolates',
          title: 'Refine by:Boxed Chocolates',
        },
        {
          name: 'Alcohol',
          link: '/uk/shop/gift-ideas/?prefn1=productType&prefv1=Alcohol',
          title: 'Refine by:Alcohol',
        },
        {
          name: 'Hampers',
          link: '/uk/shop/gift-ideas/?prefn1=productType&prefv1=Hampers',
          title: 'Refine by:Hampers',
        },
        {
          name: 'Hot Chocolate',
          link: '/uk/shop/gift-ideas/?prefn1=productType&prefv1=Hot%20Chocolate',
          title: 'Refine by:Hot Chocolate',
        },
        {
          name: 'Biscuits',
          link: '/uk/shop/gift-ideas/?prefn1=productType&prefv1=Biscuits',
          title: 'Refine by:Biscuits',
        },
        {
          name: 'Lovely Little Things',
          link: '/uk/shop/gift-ideas/?prefn1=productType&prefv1=Lovely%20Little%20Things',
          title: 'Refine by:Lovely Little Things',
        },
      ],
    },
    {
      plpPageName: 'Easter Eggs',
      pageUrl: '/uk/shop/easter-eggs/',
      data: [
        {
          name: 'Boxed Chocolate',
          link: '/uk/shop/easter-eggs/?prefn1=productType&prefv1=Boxed%20Chocolates',
          title: 'Refine by:Boxed Chocolates',
        },
        {
          name: 'Extra Thick Easter Eggs',
          link: '/uk/shop/easter-eggs/?prefn1=productType&prefv1=Extra%20Thick%20Easter%20Eggs',
          title: 'Refine by:Extra Thick Easter Eggs',
        },
        {
          name: 'Ostrich Easter Eggs',
          link: '',
          title: 'Refine by:Ostrich Easter Eggs',
        },
        //confusion
        // {
        //   name: 'Nibbly Easter Eggs',
        //   link: '',
        //   title: '',
        // },
        //confusion
        {
          name: 'Egg Sandwiches',
          link: '/uk/shop/easter-eggs/?prefn1=productType&prefv1=Chocolate%20Egg%20Sandwiches',
          title: 'Refine by:Chocolate Egg Sandwiches',
        },
        {
          name: 'Splat Easter Eggs',
          link: '/uk/shop/easter-eggs/?prefn1=productType&prefv1=Splat%20Easter%20Eggs',
          title: 'Refine by:Splat Easter Eggs',
        },
        {
          name: 'Nibbly Eggs',
          link: '/uk/shop/easter-eggs/?prefn1=productType&prefv1=Nibbly%20Eggs',
          title: 'Refine by:Nibbly Eggs',
        },
        {
          name: 'Dark',
          link: '/uk/shop/easter-eggs/?prefn1=chocolateTypes&prefv1=Dark',
          title: 'Refine by:Dark',
        },
        {
          name: 'Vegan',
          link: '/uk/shop/easter-eggs/?prefn1=isSuitableVegan&prefv1=true',
          title: 'Refine by:Suitable for vegans*',
        },
      ],
    },
    {
      plpPageName: "Mother's Day Chocolates",
      pageUrl: '/uk/shop/mothers-day-gifts/',
      data: [
        {
          name: 'Boxed Chocolate',
          link: '/uk/shop/mothers-day-gifts/?prefn1=productType&prefv1=Boxed%20Chocolates',
          title: 'Refine by:Boxed Chocolates',
        },
        //confusion
        {
          name: 'Lovely Little Things',
          link: '/uk/shop/mothers-day-gifts/?prefn1=productType&prefv1=Lovely%20Little%20Things',
          title: 'Refine by:Lovely Little Things',
        },
        //confusion
        {
          name: 'Slabs & Batons',
          link: '/uk/shop/mothers-day-gifts/?prefn1=productType&prefv1=Slabs%20%26%20Batons',
          title: 'Refine by:Slabs & Batons',
        },
        {
          name: 'Coffee',
          link: '/uk/shop/mothers-day-gifts/?prefn1=chocolateTypes&prefv1=Coffee',
          title: 'Refine by:Coffee',
        },
        {
          name: 'Dark',
          link: '/uk/shop/mothers-day-gifts/?prefn1=chocolateTypes&prefv1=Dark',
          title: 'Refine by:Dark',
        },
        {
          name: 'Vegan',
          link: '/uk/shop/mothers-day-gifts/?prefn1=isSuitableVegan&prefv1=true',
          title: 'Refine by:Suitable for vegans*',
        },
        {
          name: 'Free from Alcohol',
          link: '/uk/shop/mothers-day-gifts/?prefn1=isAlcoholFree&prefv1=true',
          title: 'Refine by:Free from alcohol',
        },
      ],
    },
    {
      plpPageName: 'Hot Chocolate',
      pageUrl: '/uk/shop/collections/products/hot-chocolate/',
      data: [
        {
          name: 'Milk',
          link: '/uk/shop/collections/products/hot-chocolate/?prefn1=chocolateTypes&prefv1=Milk',
          title: 'Refine by:Milk',
        },
        {
          name: 'Dark',
          link: '/uk/shop/collections/products/hot-chocolate/?prefn1=chocolateTypes&prefv1=Dark',
          title: 'Refine by:Dark',
        },
        //CONFUSION
        // {
        //   name: 'Caramel',
        //   link: '/uk/shop/collections/products/hot-chocolate/?prefn1=chocolateTypes&prefv1=Caramel',
        //   title: 'Refine by:Caramel',
        // },
        {
          name: 'Mint',
          link: '/uk/shop/collections/products/hot-chocolate/?prefn1=chocolateTypes&prefv1=Mint',
          title: 'Refine by:Mint',
        },
        {
          name: 'Fruity',
          link: '/uk/shop/collections/products/hot-chocolate/?prefn1=chocolateTypes&prefv1=Fruity',
          title: 'Refine by:Fruity',
        },
        {
          name: 'Vegan',
          link: '/uk/shop/collections/products/hot-chocolate/?prefn1=isSuitableVegan&prefv1=true',
          title: 'Refine by:Suitable for vegans*',
        },
      ],
    },
    {
      plpPageName: 'All Chocolate Products',
      pageUrl: '/uk/shop/collections/products/all-products/',
      data: [
        {
          name: 'Boxed Chocolates',
          link: '/uk/shop/collections/products/all-products/?prefn1=productType&prefv1=Boxed%20Chocolates',
          title: 'Refine by:Boxed Chocolates',
        },
        {
          name: 'Hot Chocolate',
          link: '/uk/shop/collections/products/all-products/?prefn1=productType&prefv1=Hot%20Chocolate',
          title: 'Refine by:Hot Chocolate',
        },
        {
          name: 'Alcohol',
          link: '/uk/shop/collections/products/all-products/?prefn1=productType&prefv1=Alcohol',
          title: 'Refine by:Alcohol',
        },
        {
          name: 'Hampers',
          link: '/uk/shop/collections/products/all-products/?prefn1=productType&prefv1=Hampers',
          title: 'Refine by:Hampers',
        },
        {
          name: 'Biscuits',
          link: '/uk/shop/collections/products/all-products/?prefn1=productType&prefv1=Biscuits',
          title: 'Refine by:Biscuits',
        },
        {
          name: 'Lovely Little Things',
          link: '/uk/shop/collections/products/all-products/?prefn1=productType&prefv1=Lovely%20Little%20Things',
          title: 'Refine by:Lovely Little Things',
        },
      ],
    },
    {
      plpPageName: 'Alcohol Gifts',
      pageUrl: '/uk/shop/collections/products/alcohol-gifts/',
      data: [
        {
          name: 'Alcohol',
          link: '/uk/shop/collections/products/alcohol-gifts/?prefn1=productType&prefv1=Alcohol',
          title: 'Refine by:Alcohol',
        },
        {
          name: 'Hampers',
          link: '/uk/shop/collections/products/alcohol-gifts/?prefn1=productType&prefv1=Hampers',
          title: 'Refine by:Hampers',
        },
        {
          name: 'Boozy',
          link: '/uk/shop/collections/products/alcohol-gifts/?prefn1=chocolateTypes&prefv1=Boozy',
          title: 'Refine by:Boozy',
        },
        {
          name: 'Coffee',
          link: '/uk/shop/collections/products/alcohol-gifts/?prefn1=chocolateTypes&prefv1=Coffee',
          title: 'Refine by:Coffee',
        },
        {
          name: 'Little Tipples',
          link: '/uk/shop/collections/products/alcohol-gifts/?pmid=23082022_tipples_multi',
          title: 'Refine by:Little Tipples - 3 for Â£12',
        },
        {
          name: 'Vegan',
          link: '/uk/shop/collections/products/alcohol-gifts/?prefn1=isSuitableVegan&prefv1=true',
          title: 'Refine by:Suitable for vegans*',
        },
      ],
    },
  ];

  //Please don't edit anything below this line
  const shared = {
    ID: 'HOT-723',
    VARIATION: '1',
    CLIENT: 'HotelChocolat',
    LIVECODE: '',
  };

  const { ID, VARIATION, CLIENT, LIVECODE } = shared;

  const logMessage = (message) => {
    if (localStorage.getItem('ucdebug')) {
      if (window.console && typeof window.console.log == 'function') {
        console.log(message);
      }
    }
  };

  const events = {
    trackerName: false,
    propertyId: false,
    analyticsReference: 'ga',
    eventCache: [],
    sendEvents: true,
    setDefaultCategory(category) {
      this.category = category;
      return this;
    },
    setDefaultAction(action) {
      this.action = action;
      return this;
    },
    setPropertyId(propertyId) {
      // If set, will look for tracker matching given property ID
      this.propertyId = propertyId;
    },
    setTrackerName(trackerName) {
      this.trackerName = trackerName;
    },
    useLegacyTracker() {
      this.analyticsReference = '_gaq';
    },

    /**
     * Shorthand for sending events
     */
    sendAuto(evVariation, evLabel, userOptions) {
      this.send(null, null, evLabel, userOptions, evVariation);
    },

    sendNormalised(evLabel, userOptions) {
      this.send(null, null, evLabel, userOptions);
    },

    /**
     * Send an event
     * @param {string} evCategory
     * @param {string} evAction
     * @param {string} evLabel
     * @param {object} userOptions
     */
    send(evCategory, evAction, evLabel, userOptions, evVariation = null) {
      const options = userOptions || {};
      let label = evLabel;
      const category = evCategory || this.category;
      const action = evAction || this.action;

      let variation = evVariation;

      if (variation != null) {
        if (variation == 0) {
          variation = 'Control';
        }
        label = 'Variation: ' + variation + ' - ' + evLabel;
      }

      if (typeof options === 'object' && options.sendOnce) {
        const eventID = `${category}${action}${label}`;
        // Check eventCache to see if this has already been sent
        if (this.eventCache.indexOf(eventID) > -1) {
          return false;
        } else {
          // Store event in cache
          this.eventCache.push(eventID);
        }
      }

      logMessage(label);

      const self = this;
      const fire = (tracker) => {
        if (self.analyticsReference === '_gaq') {
          window._gaq.push([
            '_trackEvent',
            category,
            action,
            label,
            null,
            typeof options.nonInteraction !== 'undefined' ? options.nonInteraction : true,
          ]);
        } else {
          const opts = {
            nonInteraction: options.nonInteraction ? options.nonInteraction : true,
          };

          if (options.opts) {
            for (var k in options.opts) {
              opts[k] = options.opts[k];
            }
          }

          window[self.analyticsReference](`${tracker}.send`, 'event', category, action, label, opts);
        }
      };

      if (self.trackerName) {
        if (this.sendEvents == true) {
          fire(self.trackerName);
        }
      } else {
        // Set trackerName inside polling condition
        pollerLite(
          [
            () => {
              try {
                const trackers = window[self.analyticsReference].getAll();

                if (trackers && trackers.length) {
                  if (self.propertyId) {
                    for (let i = 0; i < trackers.length; i += 1) {
                      const tracker = trackers[i];
                      if (tracker.get('trackingId') === self.propertyId) {
                        self.trackerName = tracker.get('name');
                        return true;
                      }
                    }
                  } else {
                    self.trackerName = trackers[0].get('name');
                    return true;
                  }
                }
              } catch (err) { }
            },
          ],
          () => {
            if (this.sendEvents == true) {
              fire(self.trackerName);
            }
          },
          {
            wait: 150,
          }
        );
      }
    },
  };

  const newEvents = {
    initiate: false,
    methods: ['ga4'], // ga4 | datalayer | ua
    tracker: false, // custom tracker for UA
    property: false, // custom property for GA4
    uaRef: 'ga',

    send(label) {
      if (this.methods.includes('ga4')) {
        pollerLite([() => document.readyState === 'complete'], () => {
          if (window.gtag !== undefined) {
            window.gtag('event', 'experimentation', {
              experiment_id: `${ID}-${VARIATION}`,
              experiment_label: label,
              send_to: this.property || 'default',
            });
          } else {
            window.dataLayer = window.dataLayer || [];

            if (window.customGtag === undefined) {
              window.customGtag = function () {
                window.dataLayer.push(arguments);
              };
              window.customGtag('js', new Date());
              window.customGtag('config', this.property || 'default');
            }

            window.customGtag('event', 'experimentation', {
              experiment_id: `${ID}-${VARIATION}`,
              experiment_label: label,
              send_to: this.property || 'default',
            });
          }
        });
      }

      if (this.methods.includes('datalayer')) {
        pollerLite([() => !!window.dataLayer], () => {
          window.dataLayer.push({
            event: 'experimentation',
            experiment_id: `${ID}-${VARIATION}`,
            experiment_label: label,
          });
        });
      }

      if (this.methods.includes('ua')) {
        pollerLite([() => !!window[this.uaRef]], () => {
          const tracker = this.tracker || window[this.uaRef].getAll()[0].get('name');

          window[this.uaRef](`${tracker}.send`, 'event', 'experimentation', `${ID}-${VARIATION}`, label, {
            nonInteraction: true,
          });
        });
      }
    },
  };

  const setup = () => {
    // set up events
    events.setDefaultCategory('Experimentation');
    events.setDefaultAction(CLIENT + ' - ' + ID);

    if (LIVECODE == 'true') {
      events.sendEvents = false;
    } else {
      events.sendEvents = true;
    }

    // adds document body classlist
    document.documentElement.classList.add(ID);
    document.documentElement.classList.add(`${ID}-${VARIATION}`);
  };

  const fireEvent = (label, sendOnce = false) => {
    let labelMessage = 'Test ID: ' + ID + ' Variation: ' + VARIATION + ' Label: ' + label;
    if (newEvents.initiate == false) {
      events.sendNormalised(labelMessage, {
        sendOnce: sendOnce,
      });
    } else {
      newEvents.send(label);
    }
  };

  const getNow =
    Date.now ||
    function getNow() {
      return new Date().getTime();
    };

  const mergeObjects = (target, source) => {
    const merged = target;
    Object.keys(source).forEach((key) => {
      const sourceValue = source[key];
      const targetValue = merged[key];
      const isObject = targetValue && typeof targetValue === 'object' && !(targetValue instanceof Array);

      if (isObject) {
        // If object, call function recursively to overwrite subproperties individually
        merged[key] = mergeObjects(targetValue, sourceValue);
      } else {
        // Overwrite default with value from options
        merged[key] = sourceValue;
      }
    });
    return merged;
  };

  const pollerLite = (conditions, callback, userOptions) => {
    /**
     * Default options
     */
    let options = {
      wait: 50,
      multiplier: 1.1,
      timeout: 0,
    };

    // Overwrite any default options with user supplied options
    if (userOptions) {
      options = mergeObjects(options, userOptions);
    }

    const { multiplier, wait } = options;

    /**
     * A date object created from the timeout option for easier comparison
     * @type {Date}
     */
    const timeout = options.timeout ? new Date(getNow() + options.timeout) : null;

    /**
     * Check if the poller has timed out
     * @returns {boolean}
     */
    const isTimedOut = () => timeout && getNow() > timeout;

    /**
     * Any successful polling conditions are pushed here to keep track of progress
     * @type {array}
     */
    const successfulConditions = [];

    /**
     * Check if a condition has passed
     * Conditions are evaluated differently depending on the type
     * Functions must return true and strings should be CSS selectors present in the DOM
     * @param {*} condition
     * @returns {boolean}
     */
    const evaluateCondition = (condition) => {
      if (!condition) {
        return false;
      }

      const types = {
        function: () => condition(),
        string: () => document.querySelector(condition),
      };

      const evaluate = types[typeof condition];
      return evaluate ? evaluate() : true;
    };

    /**
     * Check if all the conditions have passed
     * @returns {boolean}
     */
    const allConditionsPassed = () => successfulConditions.length === conditions.length;

    /**
     * Recursive poll for a condition until it returns true
     * @param {*} condition
     * @param {number} waitTime Time before next polling attempt
     * @param {boolean} skipWait Bypasses the wait period if true
     */
    const pollForCondition = (condition, waitTime, skipWait) => {
      // End recursion if timeout has passed
      if (timeout && isTimedOut()) {
        return false;
      }

      const result = evaluateCondition(condition);

      if (result) {
        successfulConditions.push(result);
        if (allConditionsPassed()) {
          // Run the callback and pass the results as the first argument
          callback(successfulConditions);
        }
      } else {
        setTimeout(
          () => {
            pollForCondition(condition, waitTime * multiplier);
          },
          skipWait ? 0 : waitTime
        );
      }
    };

    // Start polling for all conditions
    for (let i = 0; i < conditions.length; i += 1) {
      if (typeof conditions[i] != 'string' && typeof conditions[i] != 'function') {
        throw 'Every item in the poller array should be a function or a string';
      }
      pollForCondition(conditions[i], wait, true);
    }
  };

  const onUrlChange = (callback, onError = null) => {
    if (typeof callback !== 'function') {
      throw new Error('Callback function must be provided');
    }
    const mutationConfig = {
      childList: true,
      subtree: true,
    };
    //Create a new MutationObserver instance to observe changes to the document body
    const observer = new MutationObserver((mutationsList) => {
      mutationsList.forEach((mutation) => {
        //Store the current URL in a separate variable to make the code more concise
        const currentUrl = window.location.href;
        //Check if the URL has changed since the last observation
        if (observer.previousUrl !== currentUrl) {
          const oldHref = observer.previousUrl;
          //Update the previous URL and execute the callback function
          observer.previousUrl = currentUrl;
          //console.log('URL changed!');
          observer.disconnect();
          try {
            setTimeout(() => {
              callback(oldHref, mutation);
            }, 1500);
          } catch (error) {
            console.log(`Error in callback function: ${error}`);
          }
          observer.observe(document.documentElement, mutationConfig);
        }
      });
    });

    //Initialize the previous URL to the current URL

    try {
      observer.previousUrl = window.location.href;
      //Start observing changes to the document documentElement to detect URL changes
      observer.observe(document.documentElement, mutationConfig);
    } catch (error) {
      if (onError && typeof onError === 'function') {
        onError(error);
      } else {
        console.log(`Error starting onUrlChange observer: ${error}`);
      }
    }
  };

  const setItemsActive = () => {
    const filterWrapper = document.querySelector('#secondary.refinements');
    const activeFilterItems = filterWrapper.querySelectorAll('li.selected');
    const allNewItems = document.querySelectorAll(`.${ID}-quicklinks--item`);

    if (allNewItems && allNewItems.length > 0) {
      allNewItems.forEach((item) => {
        item.classList.remove(`${ID}__selected`);
      });
    }

    if (activeFilterItems && activeFilterItems.length > 0) {
      activeFilterItems.forEach((filterItem) => {
        const activeItem = filterItem.querySelector('a');
        const tagName = activeItem.title;
        const linkItem = document.querySelector(`.${ID}-quicklinks--item[title="${tagName}"]`);
        if (linkItem) {
          linkItem.classList.add(`${ID}__selected`);
        }
      });
    }
  };

  const observeDOM = (targetSelectorString, callbackFunction, configObject) => {
    const target = document.querySelector(`${targetSelectorString}`);
    if (!target) return;
    const config = configObject || {
      childList: true,
      subtree: true,
      attributes: true,
      characterData: true,
      characterDataOldValue: true
    };
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        observer.disconnect();
        callbackFunction(mutation);
        observer.observe(target, config);
      });
    });
    observer.observe(target, config);
  };

  const startExperiment = () => {
    const { pathname } = window.location;
    let toDisplay = false;
    let displayedArray = [];

    const isExistingPlp = plpData.filter((item) => pathname === item.pageUrl);

    if (isExistingPlp && isExistingPlp.length > 0) {
      toDisplay = true;
      displayedArray = isExistingPlp[0].data.map((item) => {
        const isAvailabaleItem = document.querySelector(`#secondary li > a[title="${item.title}"]`);
        if (isAvailabaleItem) {
          return {
            ...item,
            isStock: true,
          };
        }

        return {
          ...item,
          isStock: false,
        };
      });
    }

    if (!toDisplay) {
      fireEvent(`Interaction - the experiment shouldn't fire on this category page`, true);
    } else {
      const linksUsed = displayedArray;
      const linksHTML = `
      <div class="${ID}-quicklinks recommendations-clp">
        <div class="${ID}-quicklinks--inner">
          ${linksUsed
          .map((item) => {
            return `
                  <div data-href="${item.link}" title="${item.title}" class="${ID}-quicklinks--item ${!item.isStock ? `${ID}__notAvailable` : ''
              }">
                    <p class="${ID}__text">${item.name}</p>
                  </div>
                `;
          })
          .join('')}
        </div>
      </div>  
    `;

      pollerLite(['#page_heading'], () => {
        const main = document.getElementById('main');
        const pageHeading = document.getElementById('page_heading');
        if (!document.querySelector(`.${ID}-quicklinks`)) {
          main.insertAdjacentElement('beforebegin', pageHeading);
          main.insertAdjacentHTML('beforebegin', linksHTML);

          pageHeading.classList.add('recommendations-clp', `${ID}__pageHeading`);
          fireEvent('Interaction - experiment displayed on screen', true);
        }


        // if (!window.previousOpenedFilter && window[`${ID}__selected`]) {
        //   const selectedItem = document.querySelector(`#secondary li > a[title="${window[`${ID}__selected`]}"]`);
        //   const existingFilterItem = selectedItem.closest('#secondary .refinement.active:not(.instock):not(.price-refinement)');
        //   if (existingFilterItem) existingFilterItem.classList.remove('active');

        //   window.previousOpenedFilter = true;
        //   window[`${ID}__selected`] = null;
        // }
        const allRefinements = document.querySelectorAll('.refinement:not(.price-refinement)');
        allRefinements.forEach((refinement) => refinement.classList.remove('active'));

        //on load item active
        setItemsActive();
      });
    }
  };

  const activate = () => {
    newEvents.initiate = true;
    newEvents.methods = ['ga4'];
    newEvents.property = 'G-B37NQR1RWZ';

    setup();

    fireEvent('Conditions Met');

    document.body.addEventListener('click', (event) => {
      const { target } = event;
      if (target.closest(`.${ID}-quicklinks--item`)) {
        const clickedItem = target.closest(`.${ID}-quicklinks--item`);
        const linkText = clickedItem.querySelector('p').innerText;
        const clickItemTitle = clickedItem.title;
        const exisitingFilterItem = document.querySelector(`#secondary li > a[title="${clickItemTitle}"]`);

        const existingFilterItemWrapper = exisitingFilterItem.closest('.refinement');

        if (existingFilterItemWrapper && !existingFilterItemWrapper.classList.contains('active')) {
          window.previousOpenedFilter = false;
          window[`${ID}__selected`] = clickItemTitle;
        }

        if (exisitingFilterItem) exisitingFilterItem.click();
        clickedItem.classList.add(`${ID}__selected`);

        fireEvent(`Click - user clicked ${linkText} link`, true);
      } else if (target.closest(`.${ID}__pageHeading`) && target.closest('.expand')) {
        const pageHeading = target.closest(`.${ID}__pageHeading`);
        const seeMoreElem = pageHeading.querySelector('.see-more');
        seeMoreElem.classList.add('expanded');
      }
    });

    if (VARIATION !== 'control') {
      startExperiment();

      // observeDOM('#main', () => {
      //   startExperiment();
      // });

      onUrlChange(() => {
        startExperiment();
      });
    }
  };

  pollerLite(['#wrapper.pt_product-search-result', '#secondary', '#page_heading'], () => {
    activate();
  });
})();
